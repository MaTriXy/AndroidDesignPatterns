---
layout: post
title: Google Cloud Messaging: Overview
date: 2013-01-27
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
<p>Google Cloud Messaging (GCM) is the perfect tool for sending notifications to Android devices, and has quickly become the norm in an incre used among developers  become the norm for . While the <a href="http://developer.android.com/google/gcm/gcm.html">documentation</a> for GCM is great, it is, in my opinion, way more detailed than it needs to be. The biggest problem I have with the documentation is that it provides specific instructions on how to implement steps that are already implemented for you by the <a href="http://developer.android.com/reference/com/google/android/gcm/package-summary.html">com.google.android.gcm</a> package. For example, it describes how to implement an IntentService in order to register with GCM, when in fact the GCMRegistrar class can do all of this for you with a simple call to GCMRegistrar.register(Context, String...).</p> <p>That said, this post is meant to give a high-level overview of how the three GCM components must interact with one another in order to achieve a fully functional system. It will also provide specific instructions on how to use the <a href="http://developer.android.com/reference/com/google/android/gcm/package-summary.html">com.google.android.gcm</a> package to your advantage as well as the edge cases you must account for in the rare cases that service unavailability occurs.</p> <h4>Notation</h4> <p>Before we start, you should familiarize yourself with the notation which will be used in the rest of this post.</p> <p>Three physical entities play a role in Google Cloud Messaging:</p> <ul><li><b>Android Device (D)</b> — An Android device that receives GCM messages.</li><li><b>Application Server (S)</b> — A remote server implemented by the application developer. The application server should keep track of registered devices by storing their registration IDs and should send messages to these devices via requests to the GCM servers.</li><li><b>GCM Servers (G)</b> — The official Google servers in the cloud. The GCM servers process registration/unregistration requests from Android devices and push messages to these devices when requested by the application server.</li></ul> <p>Throughout the remainder of this post, you will see many references to the following key terms:</p> <ul><li><b>Sender ID</b> — The project number from the API Console. [screenshot]</li><li><b>Application ID</b> — The Android application's package name.</li><li><b>Registration ID</b> — An ID issued by the GCM servers to an Android device that allows it to receive GCM messages. Each registration ID is tied to an Android application running on a single, specific Android device. Registration IDs are not constant, and may be refreshed by the GCM servers at any time.</li><li><b>API key</b> — The API key from the API Console that gives the application server authorized access to Google services. [screenshot]</li></ul> <p>Finally, for the sake of brevity, this post uses the following notation:</p> <p><blockquote>"<b>A &rarr; B, (X, Y)</b>" means "<b>A sends (X, Y) to B</b>".</blockquote></p>    <h4>Registration</h4> <p>In order for an Android device to receive messages, it must obtain a Registration ID from the GCM servers:</p> <div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-1jRGO5oWDF8/UO852n0mNCI/AAAAAAAAGcg/ZwmWqs-Sjm0/s1600/registration.png" imageanchor="1" style="clear:right; float:right;margin-right:1em; margin-bottom:1em"><img border="0" height="225" width="400" style="margin:0px 0px 0px 20px;" src="http://2.bp.blogspot.com/-1jRGO5oWDF8/UO852n0mNCI/AAAAAAAAGcg/ZwmWqs-Sjm0/s400/registration.png" /></a></div> <ol><li value="1"><p><b>Device &rarr; GCM, (Sender ID, Application ID)</b></p><p>The Android device sends an (asynchronous) registration request to the GCM servers. Use <a href="http://developer.android.com/reference/com/google/android/gcm/GCMRegistrar.html#register(android.content.Context, java.lang.String...)">register(Context, String...)</a> to quickly perform this step.</p></li><li value="2"><p><b>GCM &rarr; Device, (Registration ID)</b></p><p>The GCM server responds to the device’s registration request with a Registration ID (see <a href="http://developer.android.com/reference/com/google/android/gcm/GCMBaseIntentService.html#onRegistered(android.content.Context, java.lang.String)">onRegistered(Context, String)</a>).</p><p>Note that it is possible that the GCM servers fail to process the initial request. If the failure is recoverable (i.e. a "service unavailable" error), the request will be retried using exponential backoff. Otherwise, <a href="http://developer.android.com/reference/com/google/android/gcm/GCMBaseIntentService.html#onError(android.content.Context, java.lang.String)">onError(Context, String)</a> will be called, indicating a nonrecoverable registration error.</p></li><li value="3"><p><b>Device &rarr; Server, (Registration ID)</b></p><p>The Android device sends its registration ID to the application server. The application server should store the ID in its database so it can send GCM messages to the device at a later time.</p></li><li value="4"><p><b>Server &rarr; Device, (Response)</b></p><p>The application server's response should indicate whether or not it successfully processed the request. The response should indicate a success (i.e. 200 OK) if and only if the application server successfully stored the device's registration ID in its database. If the response indicates a failure, you should either (a) retry step #3 using exponential backoff, or (b) give up completely and try retry the entire registration process at a later time.</p></li></ol>    <h4>Unregistration</h4> <p>Unlike the registration process, an Android device may unregister itself from receiving GCM messages in one of two ways: <i>directly</i> or <i>indirectly</i>.</p> <p><b><i>Directly</i></b> — The user explicitly unregisters the device from receiving GCM messages (i.e. the user clicks an "unregister" or "logout" button in the application):</p> <div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-KcR5_XRe_Fg/UO9kWJX_fJI/AAAAAAAAGc0/3SRBpH1uLL0/s1600/unregistration%2Bdirect.png" imageanchor="1" style="clear:right; float:right; margin-left:1em; margin-bottom:1em"><img border="0" height="261" width="400" src="http://1.bp.blogspot.com/-KcR5_XRe_Fg/UO9kWJX_fJI/AAAAAAAAGc0/3SRBpH1uLL0/s400/unregistration%2Bdirect.png" /></a></div> <ol><li value="1"><p><b>Device &rarr; GCM, (Application ID)</b></p><p>The Android device sends an (asynchronous) registration request to the GCM servers. Use <a href="http://developer.android.com/reference/com/google/android/gcm/GCMRegistrar.html#unregister(android.content.Context)">unregister(Context, String)</a> to quickly perform this step.</p></li><li value="2"><p><b>GCM &rarr; Device, (Response)</b></p><p>The GCM server responds to the device’s unregistration request (see <a href="http://developer.android.com/reference/com/google/android/gcm/GCMBaseIntentService.html#onUnregistered(android.content.Context, java.lang.String)">onUnregistered(Context, String)</a>).</p><p>Note that it is possible that the GCM servers fail to process the initial request. If the failure is recoverable (i.e. a "service unavailable" error), the request will be retried using exponential backoff. Otherwise,  <a href="http://developer.android.com/reference/com/google/android/gcm/GCMBaseIntentService.html#onError(android.content.Context, java.lang.String)">onError(Context, String)</a> will be called, indicating a nonrecoverable unregistration error.</p></li><li value="3"><p><b>Device &rarr; Server, (Registration ID)</b></p><p>If the unregistration request was carried out successfully, the device should notify the application server that it has unregistered from receiving GCM messages. The application server should remove the Registration ID from its database.</p></li><li value="4"><p><b>Server &rarr; Device, (Response)</b></p><p>The application server's response should indicate whether or not it successfully unregistered the device. The response should indicate a success (i.e. 200 OK) if and only if the application server successfully removed the device's registration ID from its database. If the response indicates an error, you could either (a) retry step #3 using exponential backoff, or (b) do nothing as the server will eventually detect that the device has been unregistered on its own (see below).</p></li></ol> <p><b><i>Indirectly</i></b> — the user uninstalls the Android application from the device:</p> <div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-5XShk6dosEg/UO9kiEeu66I/AAAAAAAAGdA/3k-v7yfxFs8/s1600/unregistration%2Bindirect.png" imageanchor="1" style="clear:right; float:right; margin-left:1em; margin-bottom:1em"><img border="0" height="301" width="400" src="http://4.bp.blogspot.com/-5XShk6dosEg/UO9kiEeu66I/AAAAAAAAGdA/3k-v7yfxFs8/s400/unregistration%2Bindirect.png" /></a></div> <ol><li value="1"><p>The user uninstalls the application from the device. Note that neither the application server nor the GCM server will be immediately notified when the application is uninstalled.</p></li><li value="2"><p><b>Server &rarr; GCM, (API key, Registration ID, Message)</b></p><p>At some point in the future, the application server asks GCM to send a message to the device.</p></li><li value="3"><p><b>GCM &rarr; Server, (NotRegistered error)</b></p><p>The GCM server detects that the application is no longer installed on the device and responds with a NotRegistered error.</p></li><li value="4"><p>The application server removes the now invalidated Registration ID from its database.</p></li></ol>                </div>
<h2>Comments</h2>
<div class='comments'>
</div>
