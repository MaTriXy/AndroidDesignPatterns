---
layout: post
title: Designing for Backwards Compatibility
date: 2012-06-13
comments: false
---

<h1>{{ page.title }}</h1>
<div class='post'>
<p>A common issue in Android development is backwards compatibility. How can we add cool new features from the most recent Android API while still ensuring that it runs correctly on devices running older versions of Android? This post discusses the problem by means of a simple example, and proposes a scalable, well-designed solution.</p> <p>(Note: please read this <a href="http://www.androiddesignpatterns.com/2012/06/compatability-manager-utility-class.html">short post</a> before continuing forward).</p> <h4>The Problem</h4> <p>Let's say we are writing an application that reads and writes pictures to new albums (i.e. folders) located on external storage, and that we want our application to support all devices running Donut (Android 1.6, SDK version 4) and above. Upon consulting the <a href="http://developer.android.com/guide/topics/data/data-storage.html#filesExternal">documentation</a>, we realize there is a slight problem. With the introduction of Froyo (Android 2.2, SDK version 8) came a somewhat radical change in how external storage was laid out and represented on Android devices, as well as several new API methods (see <span style="font-family: 'Courier New', Courier, monospace;"><a href="http://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;ved=0CGYQFjAA&amp;url=http%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fos%2FEnvironment.html&amp;ei=xoDWT8mwIPT16AGB--WjAw&amp;usg=AFQjCNHE5XowVrjv9ck6qWBJlAOX6S3Vaw">android.os.Environment</a></span>) that allow us access to the public storage directories. To ensure backwards compatibility all the way back to Donut, we must provide two separate implementations: one for older, pre-Froyo devices, and another for devices running Froyo and above.</p> <h4>Setting up the Manifest</h4> <p>Before we dive into the implementation, we will first update our <span style="font-family: 'Courier New', Courier, monospace;">uses-sdk</span> tag in the Android manifest. There are two attributes we must set,</p> <ul><li><span style="font-family: 'Courier New', Courier, monospace;">android:minSdkVersion="4"</span>. This attribute defines a minimum API level required for the application to run. We want our application to run on devices running Donut and above, so we set its value to <span style="font-family: 'Courier New', Courier, monospace;">"4"</span>.</li><li><span style="font-family: 'Courier New', Courier, monospace;">android:targetSdkVersion="15"</span>. This attribute is a little trickier to understand (and is incorrectly defined on blogs all over the internet). This attribute specifies the API level on which the application is designed to run. Preferably we would want its value to correspond to the most recently released SDK (<span style="font-family: 'Courier New', Courier, monospace;">"15"</span>, at the time of this posting). Strictly speaking, however, its value should be given by the largest SDK version number that we have tested your application against (we will assume we have done so for the remainder of this example).</li></ul><a name='more'></a> <p>The resulting tag in our mainfest is as follows:</p>   <p><pre class="brush: java"><br />&lt;uses-sdk <br />    android:minSdkVersion="4"<br />    android:targetSdkVersion="15" &gt;<br />&lt;/uses-sdk&gt;<br /></pre></p> <h4>Implementation</h4> <p>Our implementation will consist of an abstract class and two subclasses that extend it. The abstract <span style="font-family: 'Courier New', Courier, monospace;">AlbumStorageDirFactory</span> class enforces a simple contract by requiring its subclasses to implement the <span style="font-family: 'Courier New', Courier, monospace;">getAlbumStorageDir</span> method. The actual implementation of this method depends on the device's SDK version number. Specifically, if we are using a device running Froyo or above, its implementation will make use of new methods introduced in API level 8. Otherwise, the correct directory must be determined using pre-Froyo method calls, to ensure that our app remains backwards compatible.</p> <p><pre class="brush: java">public abstract class AlbumStorageDirFactory {<br /><br />  /**<br />   * Returns a File object that points to the folder that will store <br />   * the album's pictures. <br />   */<br />  public abstract File getAlbumStorageDir(String albumName);<br /><br />  /**<br />   * A static factory method that returns a new AlbumStorageDirFactory <br />   * instance based on the current device's SDK version.<br />   */<br />  public static AlbumStorageDirFactory newInstance() {<br />    // Note: the CompatibilityUtil class is implemented <br />    // and discussed in a previous post, entitled <br />    // "Ensuring Compatibility with a Utility Class".<br />    if (CompatabilityUtil.isFroyo()) {<br />      return new FroyoAlbumDirFactory();<br />    } else {<br />      return new BaseAlbumDirFactory();<br />    }<br />  }<br />}<br /></pre></p> <p>The two subclasses and their implementation are given below.The class also provides a static factory <span style="font-family: 'Courier New', Courier, monospace;">newInstance</span> method (note that this method makes use of the <span style="font-family: 'Courier New', Courier, monospace;">CompatabilityUtil</span> utility class, which was both implemented and discussed in a <a href="http://www.androiddesignpatterns.com/2012/06/compatability-manager-utility-class.html">previous post</a>). We discuss this method in detail in the next section.</p> <p>The <span style="font-family: 'Courier New', Courier, monospace;">BaseAlbumDirFactory</span> subclass handles pre-Froyo SDK versions:</p> <p><pre class="brush: java"><br />public class BaseAlbumDirFactory extends AlbumStorageDirFactory {<br /><br />  /**<br />   * For pre-Froyo devices, we must provide the name of the photo directory <br />   * ourselves. We choose "/dcim/" as it is the widely considered to be the <br />   * standard storage location for digital camera files.<br />   */<br />  private static final String CAMERA_DIR = "/dcim/";<br /><br />  @Override<br />  public File getAlbumStorageDir(String albumName) {<br />    return new File (<br />                    Environment.getExternalStorageDirectory() <br />                    + CAMERA_DIR <br />                    + albumName<br />    );<br />  }<br />}<br /></pre></p> <p>The <span style="font-family: 'Courier New', Courier, monospace;">FroyoAlbumDirFactory</span> subclass handles Froyo and above:</p> <p><pre class="brush: java"><br />public class FroyoAlbumDirFactory extends AlbumStorageDirFactory {<br /><br />  @Override<br />  public File getAlbumStorageDir(String albumName) {<br />    return new File(<br />        Environment.getExternalStoragePublicDirectory(<br />            Environment.DIRECTORY_PICTURES<br />        ), <br />        albumName<br />    );<br />  }<br />}<br /></pre></p> <h4>Making Sense of the Pattern</h4> <p>Take a second to study the structure of the code above. Our implementation ensures compatibility with pre-Froyo devices through a simple design. To ensure compatibility, we simply request a new <span style="font-family: 'Courier New', Courier, monospace;">AlbumStorageDirFactory</span> and call the abstract <span style="font-family: 'Courier New', Courier, monospace;">getAlbumStorageDir</span> method. The subclass is determined and instantiated at runtime depending on the Android device's SDK version number. See the sample activity below for an example on how an ordinary Activity might use this pattern to retrieve an album's directory.</p> <p><pre class="brush: java"><br />public class SampleActivity extends Activity {<br /><br />  private AlbumStorageDirFactory mAlbumFactory;<br /><br />  @Override<br />  public void onCreate(Bundle savedInstanceState) {<br />    super.onCreate(savedInstanceState);<br /><br />    // Instantiate the AlbumStorageDirFactory. Instead of<br />    // invoking the subclass' default constructors directly,<br />    // we make use of the Abstract Factory design pattern,<br />    // which encapsulates the inner details. As a result, the<br />    // Activity does not need to know `anything` about the<br />    // compatibility-specific implementation--all of this is<br />    // done behind the scenes within the "mAlbumFactory" object.     <br />    mAlbumFactory = AlbumStorageDirFactory.newInstance();<br /><br />    // get the album's directory<br />    File sampleAlbumDir = getAlbumDir("sample_album");<br />  }<br /><br />  /**<br />   * A simple helper method that returns a File corresponding<br />   * to the album named "albumName". The helper method invokes<br />   * the abstract "getAlbumStorageDir" method, which will return<br />   * correct location of the directory depending on the subclass<br />   * that was returned in "newInstance" (which depends entirely<br />   * on the device's SDK version number).<br />   */<br />  private File getAlbumDir(String albumName) {<br />    return mAlbumStorageDirFactory.getAlbumStorageDir(albumName);<br />  }<br />}<br /></pre></p> <p>There are a couple benefits to organizing the code the way we have:</p> <ul><li><b>It's easily extendable.</b> While there is certainly no need to separate our implementations into classes for simple examples (such as the one discussed above), doing so is important when working with large, complicated projects, as it will ensure changes can quickly be made down the line.</li><li><b>It encapsulates the implementation-specific details.</b> Abstracting these details from the client makes our code less cluttered and easier to read (note: in this case, "the client" was the person who wrote the Activity class).</li></ul> <h4>Conclusion</h4> <p>Android developers constantly write code to ensure backwards compatibility. As projects expand and applications become more complex, it becomes increasingly important to ensure your implementation is properly designed. Hopefully this post helped and will encourage you to more elegant solutions in the future!</p> <p>Leave a comment if you have any questions or criticisms... or just to let me know that you managed to read through this entire post without getting distracted!</p></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Alex Lockwood</div>
<div class='content'>
Hi Bill,<br /><br />You were right that there was a typo, but I think you meant the <i>getAlbumStorageDir</i> method (there is no &quot;factory&quot; at the end). This must have been a stupid copy/paste error or something... I remember changing the names of the methods at the last second. Thanks a lot for pointing that out! I have also updated/commented the <i>SampleActivity</i> implementation... please let me know if the extra details make it more clear (or if you have any suggestions on what needs additional clarification... it&#39;s a bit difficult for me since I was the one who wrote it :P). Also, if you could let me know what exactly you meant by &quot;the #1 implementation of the getAlbumStorageDirFactory method is for the pre-Froyo SDK&quot;, that&#39;d be great... I didn&#39;t follow that part.<br /><br />Thanks a lot for your (extremely nice) comment... from what I can tell, you speak rather &quot;unpretentiously&quot; as well haha. I think it&#39;s cool that you are reading this even though you don&#39;t know Android... and actually kind of flattering since this blog was inspired/motivated by my intense interest in Android development. I&#39;m currently working on a pretty massive tutorial on <i>Loader</i>s and the <i>LoaderManager</i>, so the next few posts will probably be mostly geared towards Android developers. But I will keep in mind that there are at least a couple people out there who read my posts who are primarily interested in the design patterns. I definitely hope to cover some cooler design patterns (i.e. anything <i>but</i> the abstract factory pattern :P).<br /><br />Thanks again for the comment, Bill... and don&#39;t hesitate to point out any other typos/areas that need additional clarification if you see them!<br /><br />Alex<br /><br />p.s. Your comment just inspired me to go back and re-read every single one of my posts... I have a zero tolerance for typos in this blog. :)</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Hi Alex. Thanks for sharing... I just completed a course in OOD and Programming. I really enjoyed it and you follow suit - you speak simply and unpretentiously - your thought line and variables used to instruct, along with the points conveyed, are easy to grasp... even though I&#39;ve never used an Android device! But I nevertheless pick up intuitively what&#39;s being addressed BY VIRTUE OF the design pattern and what I know of Java. <br /><br />I got lost with the &#39;SampleActivity&#39; class and I was thrown by the call to the &#39;getAlbumDir&#39; method instead of &#39;getAlbumSTORAGEdir&#39; method and well, if I followed you alright, I think when you said just above it in ref. to backwards compatibility about making a call to &#39;getAlbumStorageDirtwo&#39; method you really meant &#39;getAlbumStorageDirFACTORY(1)&#39; method. [The caps and the one are illustrative since I think you inadvertently left out the word Factory and following your thought train the #1 implementation of the getAlbumStorageDirFactory method is for the pre-Froyo SDK. If I am wrong, please correct me, but if not, I thought you might want to update your post.. because I think you will have a lot of readers with the way you write as I see it now, and a lot of people can learn from you. I&#39;m glad I ran into you myself.].<br /><br />Sincerely,<br />Bill</div>
</div>
</div>
